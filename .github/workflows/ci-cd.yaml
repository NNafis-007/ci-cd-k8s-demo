name: CI/CD Pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3 # Clone main repo
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up Docker Buildx 
        uses: docker/setup-buildx-action@v2
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: . # everything in the current directory
          push: true
          tags: |
            docker.io/nnafis007/kubernetes-cicd-tutorial:latest
            docker.io/nnafis007/kubernetes-cicd-tutorial:${{ github.sha }}
      - name: Update GitOps repository # update to trigger CD
        shell: powershell
        env:
          GIT_TOKEN: ${{ secrets.GITOPS_PAT }} # manipulate the GitOps repo
        run: |
          # Configure git credential store
          git config --global credential.helper store

          # Write credential file for Git on Windows
          $cred = "https://$($env:GIT_TOKEN):x-oauth-basic@github.com"
          $cred | Out-File -FilePath "$env:USERPROFILE\.git-credentials" -Encoding ASCII

          # Remove any existing gitops directory
          if (Test-Path gitops) { Remove-Item -Recurse -Force gitops }

          # Clone repository
          git clone https://github.com/NNafis-007/gitops-demo.git gitops
          Set-Location gitops

          # Replace any ghcr.io references with Docker Hub (docker.io)
          (Get-Content deployment.yaml) -replace 'ghcr.io/nnafis007','docker.io/nnafis007' | Set-Content deployment.yaml

          # Commit changes -> will trigger CD
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add deployment.yaml
          git commit -m 'Update image to ${{ github.sha }}'
          if ($LASTEXITCODE -ne 0) { Write-Host 'No changes to commit or commit failed' }

          # Push using token in URL
          $remote = "https://$($env:GIT_TOKEN)@github.com/NNafis-007/gitops-demo.git"
          git push -f $remote main